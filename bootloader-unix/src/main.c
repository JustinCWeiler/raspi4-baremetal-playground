#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include <unistd.h>
#include <errno.h>

#include "libserial.h"
#include "liberr.h"
#include "bootdefs.h"

uint8_t test_prog[] = {
	0x01, 0xc4, 0xbf, 0x52, 0x00, 0x80, 0x80, 0x52, 0x01, 0x04, 0x80, 0x72,
	0x20, 0x00, 0x00, 0xb9, 0x02, 0x02, 0xa0, 0x52, 0x42, 0x04, 0x00, 0x71,
	0xe1, 0xff, 0xff, 0x54, 0x81, 0x05, 0x80, 0x72, 0x20, 0x00, 0x00, 0xb9,
	0x02, 0x02, 0xa0, 0x52, 0x42, 0x04, 0x00, 0x71, 0xe1, 0xff, 0xff, 0x54,
	0xf4, 0xff, 0xff, 0x17
};

uint8_t read_byte(int fd) {
	uint8_t data;
	int ret;
	if ((ret = read(fd, &data, 1)) == 1)
		return data;

	if (ret < 0)
		die("Error reading serial: %s\n", strerror(errno));
	else
		die("Connection to serial closed\n");
}

void write_byte(int fd, uint8_t b) {
	if (write(fd, &b, 1) < 1)
		die("Error writing serial: %s\n", strerror(errno));
}

int main(void) {
	int fd = get_ttyusb();

	// read GET_INFO
	while (read_byte(fd) != GET_INFO) ;

	// write PUT_INFO
	write_byte(fd, PUT_INFO);
}
